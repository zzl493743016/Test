<html>
<head>
<script>var data={"mp":"哥飞","title":"开源了一个不使用任何后端框架纯 php 实现流式调用 OpenAI gpt 接口的项目","time":"2023-03-24 10:19:04","timeStamp":"1679624344"};</script>
<title>2023-03-24_开源了一个不使用任何后端框架纯 php 实现流式调用 OpenAI gpt 接口的项目</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:777px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;overflow:hidden;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:1.4;margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;padding:0 10px 10px 0;font-size:15px;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:0px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:#a5a5a5;}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size: 15px;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}#copyright_logo{color:#bdbdbd;}.rich_media_meta_list{margin-bottom:10px;}.reprint{background:#efefef;border-radius:5px;padding:8px;color:#1f1f1f;}.reprint a{word-break:break-all;}.topic a{padding-right:10px;}.topic p{margin:10px 0;}
</style>
<link href="http://api.soft.xbw0.com/app/weixinHelper/wxArticle.css" rel="stylesheet"/>
</head>
<body>
<div class="rich_media"><h1 class="rich_media_title" id="activity-name"><a href="https://mp.weixin.qq.com/s?__biz=MjM5OTIzMzYyMA==&mid=2650079184&idx=1&sn=ec411b332bfd2c129c8116be0d7ca166" target="_blank">开源了一个不使用任何后端框架纯 php 实现流式调用 OpenAI gpt 接口的项目</a></h1><div id="meta_content" class="rich_media_meta_list"><span id="copyright_logo" class="wx_tap_link js_wx_tap_highlight rich_media_meta icon_appmsg_tag appmsg_title_tag weui-wa-hotarea">原创&nbsp;&nbsp;</span><span class="rich_media_meta rich_media_meta_text">我是哥飞</span><span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);" class="wx_tap_link js_wx_tap_highlight weui-wa-hotarea" id="js_name">哥飞</a></span><em id="publish_time" class="rich_media_meta rich_media_meta_text">2023-03-24 10:19:04</em><em class="rich_media_meta rich_media_meta_text">广东</em></div><content><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px;color: black;padding-right: 10px;padding-left: 10px;line-height: 1.6;letter-spacing: 0px;word-break: break-word;overflow-wrap: break-word;text-align: left;font family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;"><p style="text-align: center;"><img class="rich_pages wxw-img" data-galleryid="" data-ratio="0.5" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/LBrX00GQeicvxkgIj9UhzyRl4YiakrdW62v7SpUEL3WSJWkMCQlMhPAXuF1upk5gg0S9way4p12gfqUwKQKzibpnA/640?wx_fmt=png" data-type="png" data-w="896" style=""></p><h1 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 24px;"><span style="letter-spacing: 0px;">php-openai-gpt-stream-chat-api-webui</span></h1><h1 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 24px;"></h1><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">由 @qiayue 开源的 纯 PHP 实现 GPT 流式调用和前端实时打印 webui &nbsp;。</p><h2 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 22px;"><span style="display: none;"></span>目录结构</h2><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/WAibKjHvK5nEwSTQjfsGzsMMtXu2dXU5l9oSiaiaz6Tyf53hN9HGs3UyQWXUibyxxPsBDuhXIia4z5Pv3ytSwemUyX8ctdr1uoLicj/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">/<br  />├─&nbsp;/class<br  />│&nbsp;&nbsp;├─&nbsp;Class.ChatGPT.php<br  />│&nbsp;&nbsp;├─&nbsp;Class.DFA.php<br  />│&nbsp;&nbsp;├─&nbsp;Class.StreamHandler.php<br  />├─&nbsp;/static<br  />│&nbsp;&nbsp;├─&nbsp;css<br  />│&nbsp;&nbsp;│&nbsp;&nbsp;├─&nbsp;chat.css<br  />│&nbsp;&nbsp;│&nbsp;&nbsp;├─&nbsp;monokai-sublime.css<br  />│&nbsp;&nbsp;├─&nbsp;js<br  />│&nbsp;&nbsp;│&nbsp;&nbsp;├─&nbsp;chat.js<br  />│&nbsp;&nbsp;│&nbsp;&nbsp;├─&nbsp;highlight.min.js<br  />│&nbsp;&nbsp;│&nbsp;&nbsp;├─&nbsp;marked.min.js<br  />├─&nbsp;/chat.php<br  />├─&nbsp;/index.html<br  />├─&nbsp;/README.md<br  />├─&nbsp;/sensitive_words.txt<br  /></code></pre><section data-tool="mdnice编辑器" style="overflow-x: auto;"><table><thead><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><th style="border-top-width: 1px;border-color: rgb(204, 204, 204);text-align: left;background-color: rgb(240, 240, 240);min-width: 85px;">目录/文件</th><th style="border-top-width: 1px;border-color: rgb(204, 204, 204);text-align: left;background-color: rgb(240, 240, 240);min-width: 85px;">说明</th></tr></thead><tbody style="border-width: 0px;border-style: initial;border-color: initial;"><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">程序根目录</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/class</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">php类文件目录</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/class/Class.ChatGPT.php</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">ChatGPT 类，用于处理前端请求，并向 OpenAI 接口提交请求</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/class/Class.DFA.php</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">DFA 类，用于敏感词校验和替换</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/class/Class.StreamHandler.php</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">StreamHandler 类，用于实时处理 OpenAI 流式返回的数据</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/static</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">存放所有前端页面所需的静态文件</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/static/css</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">存放前端页面所有的 css 文件</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/static/css/chat.css</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">前端页面聊天样式文件</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/static/css/monokai-sublime.css</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">highlight 代码高亮插件的主题样式文件</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/static/js</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">存放前端页面所有的 js 文件</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/static/js/chat.js</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">前端聊天交互 js 代码</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/static/js/highlight.min.js</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">代码高亮 js 库</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/static/js/marked.min.js</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">markdown 解析 js 库</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/chat.php</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">前端聊天请求的后端入口文件，在这里引入 php 类文件</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/index.html</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">前端页面 html 代码</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/README.md</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">仓库描述文件</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-color: rgb(204, 204, 204);min-width: 85px;">/sensitive_words.txt</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;">敏感词文件，一行一个敏感词，需要你自己收集敏感词，也可以加我微信（同 GitHub id）找我要</td></tr></tbody></table></section><h2 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 22px;"><span style="display: none;"></span>使用方法</h2><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">本项目代码，没有使用任何框架，也没有引入任何第三方后端库，前端引入了代码高亮库 highlight 和 markdown 解析库 marked 都已经下载项目内了，所以拿到代码不用任何安装即可直接使用。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">唯二要做的就是把你自己的 api key 填进去。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">获取源码后，修改 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">chat.php</code> ，填写 OpenAI 的 api key 进去，具体请见：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/WAibKjHvK5nEwSTQjfsGzsMMtXu2dXU5l9oSiaiaz6Tyf53hN9HGs3UyQWXUibyxxPsBDuhXIia4z5Pv3ytSwemUyX8ctdr1uoLicj/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">$chat&nbsp;=&nbsp;<span style="color: #c678dd;line-height: 26px;">new</span>&nbsp;ChatGPT([<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">'api_key'</span>&nbsp;=&gt;&nbsp;<span style="color: #98c379;line-height: 26px;">'此处需要填入&nbsp;openai&nbsp;的&nbsp;api&nbsp;key&nbsp;'</span>,<br  />]);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如果开启敏感词检测功能，需要把敏感词一行一个放入 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">sensitive_words.txt</code> 文件中。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">开了一个微信群，欢迎入群交流：</p><p style="text-align: center;"><img class="rich_pages wxw-img js_insertlocalimg" data-ratio="1.405431619786615" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_jpg/LBrX00GQeicvxkgIj9UhzyRl4YiakrdW62Koz7RHuUXrSicYqN2EVYPovQy4vTxibkWSonfP34N4icqomibYgpxFxYRA/640?wx_fmt=jpeg" data-type="jpeg" data-w="1031" style=""></p><h2 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 22px;"><span style="display: none;"></span>原理说明</h2><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 20px;"><span style="display: none;"></span>流式接收 OpenAI 的返回数据<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">后端 Class.ChatGPT.php 中用 curl 向 OpenAI 发起请求，使用 curl 的 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">CURLOPT_WRITEFUNCTION</code> 设置回调函数，同时请求参数里 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">'stream' =&gt; true</code> 告诉 OpenAI 开启流式传输。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">我们通过 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">curl_setopt($ch, CURLOPT_WRITEFUNCTION, [$this-&gt;streamHandler, 'callback']);</code> 设置使用 StreamHandler 类的实例化对象 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">$this-&gt;streamHandler</code> 的 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">callback</code> 方法来处理 OpenAI 返回的数据。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">OpenAI 会在模型每次输出时返回 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">data: {"id":"","object":"","created":1679616251,"model":"","choices":[{"delta":{"content":""},"index":0,"finish_reason":null}]}</code> 格式字符串，其中我们需要的回答就在 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">choices[0]['delta']['content']</code> 里，当然我们也要做好异常判断，不能直接这样获取数据。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">另外，实际因为网络传输问题，每次 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">callback</code> 函数收到的数据并不一定只有一条 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">data: {"key":"value"}</code> 格式的数据，有可能只有半条，也有可能有多条，还有可能有N条半。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">所以我们在 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">StreamHandler</code> 类中增加了 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">data_buffer</code> 属性来存储无法解析的半条数据。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">这里根据 OpenAI 的返回数据格式，做了一些特殊处理，具体代码如下：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/WAibKjHvK5nEwSTQjfsGzsMMtXu2dXU5l9oSiaiaz6Tyf53hN9HGs3UyQWXUibyxxPsBDuhXIia4z5Pv3ytSwemUyX8ctdr1uoLicj/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;"><span style="color: #c678dd;line-height: 26px;">public</span>&nbsp;<span style="line-height: 26px;"><span style="color: #c678dd;line-height: 26px;">function</span>&nbsp;<span style="color: #61aeee;line-height: 26px;">callback</span><span style="line-height: 26px;">($ch,&nbsp;$data)</span>&nbsp;</span>{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">$this</span>-&gt;counter&nbsp;+=&nbsp;<span style="color: #d19a66;line-height: 26px;">1</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_put_contents(<span style="color: #98c379;line-height: 26px;">'./log/data.'</span>.<span style="color: #c678dd;line-height: 26px;">$this</span>-&gt;qmd5.<span style="color: #98c379;line-height: 26px;">'.log'</span>,&nbsp;<span style="color: #c678dd;line-height: 26px;">$this</span>-&gt;counter.<span style="color: #98c379;line-height: 26px;">'=='</span>.$data.PHP_EOL.<span style="color: #98c379;line-height: 26px;">'--------------------'</span>.PHP_EOL,&nbsp;FILE_APPEND);<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;json_decode($data,&nbsp;<span style="color: #c678dd;line-height: 26px;">TRUE</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>(is_array($result)){<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">$this</span>-&gt;end(<span style="color: #98c379;line-height: 26px;">'openai 请求错误：'</span>.json_encode($result));<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">return</span>&nbsp;strlen($data);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #5c6370;font-style: italic;line-height: 26px;">/*<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;此处步骤仅针对&nbsp;openai&nbsp;接口而言<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;每次触发回调函数时，里边会有多条data数据，需要分割<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如某次收到&nbsp;$data 如下所示：<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data:&nbsp;{"id":"chatcmpl-6wimHHBt4hKFHEpFnNT2ryUeuRRJC","object":"chat.completion.chunk","created":1679453169,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"role":"assistant"},"index":0,"finish_reason":null}]}\n\ndata:&nbsp;{"id":"chatcmpl-6wimHHBt4hKFHEpFnNT2ryUeuRRJC","object":"chat.completion.chunk","created":1679453169,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"以下"},"index":0,"finish_reason":null}]}\n\ndata:&nbsp;{"id":"chatcmpl-6wimHHBt4hKFHEpFnNT2ryUeuRRJC","object":"chat.completion.chunk","created":1679453169,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"是"},"index":0,"finish_reason":null}]}\n\ndata:&nbsp;{"id":"chatcmpl-6wimHHBt4hKFHEpFnNT2ryUeuRRJC","object":"chat.completion.chunk","created":1679453169,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{"content":"使用"},"index":0,"finish_reason":null}]}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最后两条一般是这样的：<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data:&nbsp;{"id":"chatcmpl-6wimHHBt4hKFHEpFnNT2ryUeuRRJC","object":"chat.completion.chunk","created":1679453169,"model":"gpt-3.5-turbo-0301","choices":[{"delta":{},"index":0,"finish_reason":"stop"}]}\n\ndata:&nbsp;[DONE]<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;根据以上 openai 的数据格式，分割步骤如下：<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span><br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #5c6370;font-style: italic;line-height: 26px;">//&nbsp;0、把上次缓冲区内数据拼接上本次的data</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$buffer&nbsp;=&nbsp;<span style="color: #c678dd;line-height: 26px;">$this</span>-&gt;data_buffer.$data;<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #5c6370;font-style: italic;line-height: 26px;">//&nbsp;1、把所有的&nbsp;'data:&nbsp;{'&nbsp;替换为&nbsp;'{'&nbsp;，'data:&nbsp;['&nbsp;换成&nbsp;'['</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$buffer&nbsp;=&nbsp;str_replace(<span style="color: #98c379;line-height: 26px;">'data:&nbsp;{'</span>,&nbsp;<span style="color: #98c379;line-height: 26px;">'{'</span>,&nbsp;$buffer);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$buffer&nbsp;=&nbsp;str_replace(<span style="color: #98c379;line-height: 26px;">'data:&nbsp;['</span>,&nbsp;<span style="color: #98c379;line-height: 26px;">'['</span>,&nbsp;$buffer);<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #5c6370;font-style: italic;line-height: 26px;">//&nbsp;2、把所有的&nbsp;'}\n\n{'&nbsp;替换维&nbsp;'}[br]{'&nbsp;，&nbsp;'}\n\n['&nbsp;替换为&nbsp;'}[br]['</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$buffer&nbsp;=&nbsp;str_replace(<span style="color: #98c379;line-height: 26px;">'}'</span>.PHP_EOL.PHP_EOL.<span style="color: #98c379;line-height: 26px;">'{'</span>,&nbsp;<span style="color: #98c379;line-height: 26px;">'}[br]{'</span>,&nbsp;$buffer);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$buffer&nbsp;=&nbsp;str_replace(<span style="color: #98c379;line-height: 26px;">'}'</span>.PHP_EOL.PHP_EOL.<span style="color: #98c379;line-height: 26px;">'['</span>,&nbsp;<span style="color: #98c379;line-height: 26px;">'}[br]['</span>,&nbsp;$buffer);<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #5c6370;font-style: italic;line-height: 26px;">//&nbsp;3、用&nbsp;'[br]'&nbsp;分割成多行数组</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$lines&nbsp;=&nbsp;explode(<span style="color: #98c379;line-height: 26px;">'[br]'</span>,&nbsp;$buffer);<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #5c6370;font-style: italic;line-height: 26px;">//&nbsp;4、循环处理每一行，对于最后一行需要判断是否是完整的json</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$line_c&nbsp;=&nbsp;count($lines);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">foreach</span>($lines&nbsp;<span style="color: #c678dd;line-height: 26px;">as</span>&nbsp;$li=&gt;$line){<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>(trim($line)&nbsp;==&nbsp;<span style="color: #98c379;line-height: 26px;">'[DONE]'</span>){<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #5c6370;font-style: italic;line-height: 26px;">//数据传输结束</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">$this</span>-&gt;data_buffer&nbsp;=&nbsp;<span style="color: #98c379;line-height: 26px;">''</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">$this</span>-&gt;counter&nbsp;=&nbsp;<span style="color: #d19a66;line-height: 26px;">0</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">$this</span>-&gt;sensitive_check();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">$this</span>-&gt;end();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">break</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$line_data&nbsp;=&nbsp;json_decode(trim($line),&nbsp;<span style="color: #c678dd;line-height: 26px;">TRUE</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>(&nbsp;!is_array($line_data)&nbsp;||&nbsp;!<span style="color: #c678dd;line-height: 26px;">isset</span>($line_data[<span style="color: #98c379;line-height: 26px;">'choices'</span>])&nbsp;||&nbsp;!<span style="color: #c678dd;line-height: 26px;">isset</span>($line_data[<span style="color: #98c379;line-height: 26px;">'choices'</span>][<span style="color: #d19a66;line-height: 26px;">0</span>])&nbsp;){<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>($li&nbsp;==&nbsp;($line_c&nbsp;-&nbsp;<span style="color: #d19a66;line-height: 26px;">1</span>)){<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #5c6370;font-style: italic;line-height: 26px;">//如果是最后一行</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">$this</span>-&gt;data_buffer&nbsp;=&nbsp;$line;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">break</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #5c6370;font-style: italic;line-height: 26px;">//如果是中间行无法json解析，则写入错误日志中</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_put_contents(<span style="color: #98c379;line-height: 26px;">'./log/error.'</span>.<span style="color: #c678dd;line-height: 26px;">$this</span>-&gt;qmd5.<span style="color: #98c379;line-height: 26px;">'.log'</span>,&nbsp;json_encode([<span style="color: #98c379;line-height: 26px;">'i'</span>=&gt;<span style="color: #c678dd;line-height: 26px;">$this</span>-&gt;counter,&nbsp;<span style="color: #98c379;line-height: 26px;">'line'</span>=&gt;$line,&nbsp;<span style="color: #98c379;line-height: 26px;">'li'</span>=&gt;$li],&nbsp;JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT).PHP_EOL.PHP_EOL,&nbsp;FILE_APPEND);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">continue</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>(&nbsp;<span style="color: #c678dd;line-height: 26px;">isset</span>($line_data[<span style="color: #98c379;line-height: 26px;">'choices'</span>][<span style="color: #d19a66;line-height: 26px;">0</span>][<span style="color: #98c379;line-height: 26px;">'delta'</span>])&nbsp;&&&nbsp;<span style="color: #c678dd;line-height: 26px;">isset</span>($line_data[<span style="color: #98c379;line-height: 26px;">'choices'</span>][<span style="color: #d19a66;line-height: 26px;">0</span>][<span style="color: #98c379;line-height: 26px;">'delta'</span>][<span style="color: #98c379;line-height: 26px;">'content'</span>])&nbsp;){<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">$this</span>-&gt;sensitive_check($line_data[<span style="color: #98c379;line-height: 26px;">'choices'</span>][<span style="color: #d19a66;line-height: 26px;">0</span>][<span style="color: #98c379;line-height: 26px;">'delta'</span>][<span style="color: #98c379;line-height: 26px;">'content'</span>]);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">return</span>&nbsp;strlen($data);<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 20px;"><span style="display: none;"></span>敏感词检测<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">我们使用了 DFA 算法来实现敏感词检测，按照 ChatGPT 的解释，<code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">"DFA"是指“确定性有限自动机”（Deterministic Finite Automaton）</code> ，<code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">DfaFilter（确定有限自动机过滤器）通常是指一种用于文本处理和匹配的算法</code>。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">Class.DFA.php 类代码是 GPT4 写的，具体实现代码见源码。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">这里介绍一下使用方法，创建一个 DFA 实例需要传入敏感词文件路径：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/WAibKjHvK5nEwSTQjfsGzsMMtXu2dXU5l9oSiaiaz6Tyf53hN9HGs3UyQWXUibyxxPsBDuhXIia4z5Pv3ytSwemUyX8ctdr1uoLicj/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">$dfa&nbsp;=&nbsp;<span style="color: #c678dd;line-height: 26px;">new</span>&nbsp;DFA([<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">'words_file'</span>&nbsp;=&gt;&nbsp;<span style="color: #98c379;line-height: 26px;">'./sensitive_words.txt'</span>,<br  />]);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">之后就可以用 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">$dfa-&gt;containsSensitiveWords($inputText)</code> 来判断 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">$inputText</code> 是否包含敏感词，返回值是 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">TRUE</code> 或 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">FALSE</code> 的布尔值，也可以用 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">$outputText = $dfa-&gt;replaceWords($inputText)</code> 来进行敏感词替换，所有在 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">sensitive_words.txt</code> 中指定的敏感词都会被替换为三个<code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">*</code>号。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如果不想开启敏感词检测，把 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">chat.php</code> 中的以下三句注释掉即可：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/WAibKjHvK5nEwSTQjfsGzsMMtXu2dXU5l9oSiaiaz6Tyf53hN9HGs3UyQWXUibyxxPsBDuhXIia4z5Pv3ytSwemUyX8ctdr1uoLicj/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">$dfa&nbsp;=&nbsp;<span style="color: #c678dd;line-height: 26px;">new</span>&nbsp;DFA([<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">'words_file'</span>&nbsp;=&gt;&nbsp;<span style="color: #98c379;line-height: 26px;">'./sensitive_words.txt'</span>,<br  />]);<br  />$chat-&gt;set_dfa($dfa);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如果没有开启敏感词检测，那么每次 OpenAI 的返回都会实时返回给前端。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如果开启了敏感词检测，会查找 OpenAI 返回中的换行符和停顿符号 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">['，', '。', '；', '？', '！', '……']</code> 等来进行分句，每一句都使用 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">$outputText = $dfa-&gt;replaceWords($inputText)</code> 来替换敏感词，之后整句返回给前端。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">开启敏感词后，加载敏感词文件需要时间，每次检测时也是逐句检测，而不是逐词检测，也会导致返回变慢。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">所以如果是自用，可以不开启敏感词检测，如果是部署出去给其他人用，为了保护你的域名安全和你的安全，最好开启敏感词检测。</p><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 20px;"><span style="display: none;"></span>流式返回给前端<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">直接看 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">chat.php</code> 的注释会更清楚：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/WAibKjHvK5nEwSTQjfsGzsMMtXu2dXU5l9oSiaiaz6Tyf53hN9HGs3UyQWXUibyxxPsBDuhXIia4z5Pv3ytSwemUyX8ctdr1uoLicj/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;"><span style="color: #5c6370;font-style: italic;line-height: 26px;">/*<br  />以下几行注释由&nbsp;GPT4&nbsp;生成<br  />*/</span><br  /><br  /><span style="color: #5c6370;font-style: italic;line-height: 26px;">//&nbsp;这行代码用于关闭输出缓冲。关闭后，脚本的输出将立即发送到浏览器，而不是等待缓冲区填满或脚本执行完毕。</span><br  />ini_set(<span style="color: #98c379;line-height: 26px;">'output_buffering'</span>,&nbsp;<span style="color: #98c379;line-height: 26px;">'off'</span>);<br  /><br  /><span style="color: #5c6370;font-style: italic;line-height: 26px;">//&nbsp;这行代码禁用了 zlib 压缩。通常情况下，启用 zlib 压缩可以减小发送到浏览器的数据量，但对于服务器发送事件来说，实时性更重要，因此需要禁用压缩。</span><br  />ini_set(<span style="color: #98c379;line-height: 26px;">'zlib.output_compression'</span>,&nbsp;<span style="color: #c678dd;line-height: 26px;">false</span>);<br  /><br  /><span style="color: #5c6370;font-style: italic;line-height: 26px;">//&nbsp;这行代码使用循环来清空所有当前激活的输出缓冲区。ob_end_flush()&nbsp;函数会刷新并关闭最内层的输出缓冲区，@&nbsp;符号用于抑制可能出现的错误或警告。</span><br  /><span style="color: #c678dd;line-height: 26px;">while</span>&nbsp;(@ob_end_flush())&nbsp;{}<br  /><br  /><span style="color: #5c6370;font-style: italic;line-height: 26px;">//&nbsp;这行代码设置 HTTP 响应的 Content-Type 为 text/event-stream，这是服务器发送事件（SSE）的 MIME 类型。</span><br  />header(<span style="color: #98c379;line-height: 26px;">'Content-Type:&nbsp;text/event-stream'</span>);<br  /><br  /><span style="color: #5c6370;font-style: italic;line-height: 26px;">//&nbsp;这行代码设置 HTTP 响应的 Cache-Control 为 no-cache，告诉浏览器不要缓存此响应。</span><br  />header(<span style="color: #98c379;line-height: 26px;">'Cache-Control:&nbsp;no-cache'</span>);<br  /><br  /><span style="color: #5c6370;font-style: italic;line-height: 26px;">//&nbsp;这行代码设置 HTTP 响应的 Connection 为 keep-alive，保持长连接，以便服务器可以持续发送事件到客户端。</span><br  />header(<span style="color: #98c379;line-height: 26px;">'Connection:&nbsp;keep-alive'</span>);<br  /><br  /><span style="color: #5c6370;font-style: italic;line-height: 26px;">//&nbsp;这行代码设置 HTTP 响应的自定义头部 X-Accel-Buffering 为 no，用于禁用某些代理或 Web 服务器（如 Nginx）的缓冲。</span><br  /><span style="color: #5c6370;font-style: italic;line-height: 26px;">//&nbsp;这有助于确保服务器发送事件在传输过程中不会受到缓冲影响。</span><br  />header(<span style="color: #98c379;line-height: 26px;">'X-Accel-Buffering:&nbsp;no'</span>);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">之后我们每次想给前端返回数据，用以下代码即可：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/WAibKjHvK5nEwSTQjfsGzsMMtXu2dXU5l9oSiaiaz6Tyf53hN9HGs3UyQWXUibyxxPsBDuhXIia4z5Pv3ytSwemUyX8ctdr1uoLicj/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;"><span style="color: #c678dd;line-height: 26px;">echo</span>&nbsp;<span style="color: #98c379;line-height: 26px;">'data:&nbsp;'</span>.json_encode([<span style="color: #98c379;line-height: 26px;">'time'</span>=&gt;date(<span style="color: #98c379;line-height: 26px;">'Y-m-d&nbsp;H:i:s'</span>),&nbsp;<span style="color: #98c379;line-height: 26px;">'content'</span>=&gt;<span style="color: #98c379;line-height: 26px;">'答：&nbsp;'</span>]).PHP_EOL.PHP_EOL;<br  />flush();<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">这里我们定义了我们自己使用的一个数据格式，里边只放了 time 和 content ，不用解释都懂，time 是时间， content 就是我们要返回给前端的内容。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">注意，回答全部传输完毕后，我们需要关闭连接，可以用以下代码：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/WAibKjHvK5nEwSTQjfsGzsMMtXu2dXU5l9oSiaiaz6Tyf53hN9HGs3UyQWXUibyxxPsBDuhXIia4z5Pv3ytSwemUyX8ctdr1uoLicj/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;"><span style="color: #c678dd;line-height: 26px;">echo</span>&nbsp;<span style="color: #98c379;line-height: 26px;">'retry:&nbsp;86400000'</span>.PHP_EOL;&nbsp;<span style="color: #5c6370;font-style: italic;line-height: 26px;">//&nbsp;告诉前端如果发生错误，隔多久之后才轮询一次</span><br  /><span style="color: #c678dd;line-height: 26px;">echo</span>&nbsp;<span style="color: #98c379;line-height: 26px;">'event:&nbsp;close'</span>.PHP_EOL;&nbsp;<span style="color: #5c6370;font-style: italic;line-height: 26px;">//&nbsp;告诉前端，结束了，该说再见了</span><br  /><span style="color: #c678dd;line-height: 26px;">echo</span>&nbsp;<span style="color: #98c379;line-height: 26px;">'data:&nbsp;Connection&nbsp;closed'</span>.PHP_EOL.PHP_EOL;&nbsp;<span style="color: #5c6370;font-style: italic;line-height: 26px;">//&nbsp;告诉前端，连接已关闭</span><br  />flush();<br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 20px;"><span style="display: none;"></span>EventSource<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">前端 js 通过 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">const eventSource = new EventSource(url);</code> 开启一个 EventSource &nbsp;请求。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">之后服务器按照 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">data: {"kev1":"value1","kev2":"value2"}</code> 格式向前端发送数据，前端就可以在 EventSource 的 message 回调事件中的 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">event.data</code> 里获取 &nbsp;<code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">{"kev1":"value1","kev2":"value2"}</code> 字符串形式 json 数据，再通过 <code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;">JSON.parse(event.data)</code> 就可以得到 js 对象。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">具体代码在 getAnswer 函数中，如下所示：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/WAibKjHvK5nEwSTQjfsGzsMMtXu2dXU5l9oSiaiaz6Tyf53hN9HGs3UyQWXUibyxxPsBDuhXIia4z5Pv3ytSwemUyX8ctdr1uoLicj/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;"><span style="line-height: 26px;"><span style="color: #c678dd;line-height: 26px;">function</span>&nbsp;<span style="color: #61aeee;line-height: 26px;">getAnswer</span>(<span style="line-height: 26px;">inputValue</span>)</span>{<br  />&nbsp;&nbsp;&nbsp;&nbsp;inputValue&nbsp;=&nbsp;inputValue.replace(<span style="color: #98c379;line-height: 26px;">'+'</span>,&nbsp;<span style="color: #98c379;line-height: 26px;">'{[$add$]}'</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">const</span>&nbsp;url&nbsp;=&nbsp;<span style="color: #98c379;line-height: 26px;">"./chat.php?q="</span>+inputValue;<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">const</span>&nbsp;eventSource&nbsp;=&nbsp;<span style="color: #c678dd;line-height: 26px;">new</span>&nbsp;EventSource(url);<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;eventSource.addEventListener(<span style="color: #98c379;line-height: 26px;">"open"</span>,&nbsp;(event)&nbsp;=&gt;&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">console</span>.log(<span style="color: #98c379;line-height: 26px;">"连接已建立"</span>,&nbsp;<span style="color: #e6c07b;line-height: 26px;">JSON</span>.stringify(event));<br  />&nbsp;&nbsp;&nbsp;&nbsp;});<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;eventSource.addEventListener(<span style="color: #98c379;line-height: 26px;">"message"</span>,&nbsp;(event)&nbsp;=&gt;&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #5c6370;font-style: italic;line-height: 26px;">//console.log("接收数据：", event);</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">try</span>&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">var</span>&nbsp;result&nbsp;=&nbsp;<span style="color: #e6c07b;line-height: 26px;">JSON</span>.parse(event.data);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>(result.time&nbsp;&&&nbsp;result.content&nbsp;){<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;answerWords.push(result.content);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contentIdx&nbsp;+=&nbsp;<span style="color: #d19a66;line-height: 26px;">1</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #c678dd;line-height: 26px;">catch</span>&nbsp;(error)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">console</span>.log(error);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;});<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;eventSource.addEventListener(<span style="color: #98c379;line-height: 26px;">"error"</span>,&nbsp;(event)&nbsp;=&gt;&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">console</span>.error(<span style="color: #98c379;line-height: 26px;">"发生错误："</span>,&nbsp;<span style="color: #e6c07b;line-height: 26px;">JSON</span>.stringify(event));<br  />&nbsp;&nbsp;&nbsp;&nbsp;});<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;eventSource.addEventListener(<span style="color: #98c379;line-height: 26px;">"close"</span>,&nbsp;(event)&nbsp;=&gt;&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">console</span>.log(<span style="color: #98c379;line-height: 26px;">"连接已关闭"</span>,&nbsp;<span style="color: #e6c07b;line-height: 26px;">JSON</span>.stringify(event.data));<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eventSource.close();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contentEnd&nbsp;=&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">console</span>.log((<span style="color: #c678dd;line-height: 26px;">new</span>&nbsp;<span style="color: #e6c07b;line-height: 26px;">Date</span>().getTime()),&nbsp;<span style="color: #98c379;line-height: 26px;">'answer&nbsp;end'</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;});<br  />}<br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 20px;"><span style="display: none;"></span>打字机效果<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">对于后端返回的所有回复内容，我们需要用打字机形式打印出来。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">最初的方案是</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/WAibKjHvK5nEwSTQjfsGzsMMtXu2dXU5l9oSiaiaz6Tyf53hN9HGs3UyQWXUibyxxPsBDuhXIia4z5Pv3ytSwemUyX8ctdr1uoLicj/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;"><span style="line-height: 26px;"><span style="color: #c678dd;line-height: 26px;">function</span>&nbsp;<span style="color: #61aeee;line-height: 26px;">typingWords</span>(<span style="line-height: 26px;"></span>)</span>{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>(contentEnd&nbsp;&&&nbsp;contentIdx==typingIdx){<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clearInterval(typingTimer);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;answerContent&nbsp;=&nbsp;<span style="color: #98c379;line-height: 26px;">''</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;answerWords&nbsp;=&nbsp;[];<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;answers&nbsp;=&nbsp;[];<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qaIdx&nbsp;+=&nbsp;<span style="color: #d19a66;line-height: 26px;">1</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;typingIdx&nbsp;=&nbsp;<span style="color: #d19a66;line-height: 26px;">0</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contentIdx&nbsp;=&nbsp;<span style="color: #d19a66;line-height: 26px;">0</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contentEnd&nbsp;=&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lastWord&nbsp;=&nbsp;<span style="color: #98c379;line-height: 26px;">''</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lastLastWord&nbsp;=&nbsp;<span style="color: #98c379;line-height: 26px;">''</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input.disabled&nbsp;=&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sendButton.disabled&nbsp;=&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">console</span>.log((<span style="color: #c678dd;line-height: 26px;">new</span>&nbsp;<span style="color: #e6c07b;line-height: 26px;">Date</span>().getTime()),&nbsp;<span style="color: #98c379;line-height: 26px;">'typing&nbsp;end'</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">return</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>(contentIdx&lt;=typingIdx){<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">return</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>(typing){<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">return</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;typing&nbsp;=&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span>;<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>(!answers[qaIdx]){<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;answers[qaIdx]&nbsp;=&nbsp;<span style="color: #e6c07b;line-height: 26px;">document</span>.getElementById(<span style="color: #98c379;line-height: 26px;">'answer-'</span>+qaIdx);<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">const</span>&nbsp;content&nbsp;=&nbsp;answerWords[typingIdx];<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>(content.indexOf(<span style="color: #98c379;line-height: 26px;">'`'</span>)&nbsp;!=&nbsp;<span style="color: #d19a66;line-height: 26px;">-1</span>){<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>(content.indexOf(<span style="color: #98c379;line-height: 26px;">'```'</span>)&nbsp;!=&nbsp;<span style="color: #d19a66;line-height: 26px;">-1</span>){<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;codeStart&nbsp;=&nbsp;!codeStart;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<span style="color: #c678dd;line-height: 26px;">else</span>&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>(content.indexOf(<span style="color: #98c379;line-height: 26px;">'``'</span>)&nbsp;!=&nbsp;<span style="color: #d19a66;line-height: 26px;">-1</span>&nbsp;&&&nbsp;(lastWord&nbsp;+&nbsp;content).indexOf(<span style="color: #98c379;line-height: 26px;">'```'</span>)&nbsp;!=&nbsp;<span style="color: #d19a66;line-height: 26px;">-1</span>){<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;codeStart&nbsp;=&nbsp;!codeStart;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<span style="color: #c678dd;line-height: 26px;">else</span>&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>(content.indexOf(<span style="color: #98c379;line-height: 26px;">'`'</span>)&nbsp;!=&nbsp;<span style="color: #d19a66;line-height: 26px;">-1</span>&nbsp;&&&nbsp;(lastLastWord&nbsp;+&nbsp;lastWord&nbsp;+&nbsp;content).indexOf(<span style="color: #98c379;line-height: 26px;">'```'</span>)&nbsp;!=&nbsp;<span style="color: #d19a66;line-height: 26px;">-1</span>){<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;codeStart&nbsp;=&nbsp;!codeStart;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;lastLastWord&nbsp;=&nbsp;lastWord;<br  />&nbsp;&nbsp;&nbsp;&nbsp;lastWord&nbsp;=&nbsp;content;<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;answerContent&nbsp;+=&nbsp;content;<br  />&nbsp;&nbsp;&nbsp;&nbsp;answers[qaIdx].innerHTML&nbsp;=&nbsp;marked.parse(answerContent+(codeStart?<span style="color: #98c379;line-height: 26px;">'\n\n```'</span>:<span style="color: #98c379;line-height: 26px;">''</span>));<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;typingIdx&nbsp;+=&nbsp;<span style="color: #d19a66;line-height: 26px;">1</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;typing&nbsp;=&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>;<br  />}<br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 20px;"><span style="display: none;"></span>其它<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">更多其它细节请看代码，如果对代码有疑问的，请加我微信（同 GitHub id）</p><h2 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 22px;"><span style="display: none;"></span>License</h2><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">BSD 2-Clause</p></section><p>点击阅读原文，查看开源代码<br  /></p><p style="display: none;"><mp-style-type data-value="3"></mp-style-type></p><div class="msg_source_url"><a href="https://github.com/qiayue/php-openai-gpt-stream-chat-api-webui" target="_blank">阅读原文</a></div></content>
</div>
</body>
</html>